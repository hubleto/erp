#!/usr/bin/env php
<?php

if (php_sapi_name() !== 'cli') exit;

// cli agent is used also in 'Installer/template/hubleto'
if (!isset($config) || !is_array($config)) $config = [];

$config['sessionSalt'] = 'hubleto-cli-agent';

$main = new \HubletoMain\Loader($config);
$main->init();

// MAIN code

\Hubleto\Terminal::green("Hubleto CLI agent (main version: " . \Composer\InstalledVersions::getPrettyVersion("hubleto/main") . ").\n");

$action = (string) ($argv[1] ?? '');

if (!empty($action)) {
  try {
    $command = null;
    switch ($action) {
      case 'help': $command = $main->getService(\HubletoMain\Cli\Agent\CommandHelp::class)->setArguments($argv); break;
      case 'init': $command = $main->getService(\HubletoMain\Cli\Agent\CommandInit::class)->setArguments($argv); break;
      case 'app':
        switch ($argv[2]) {
          case 'list': $command = $main->getService(\HubletoMain\Cli\Agent\App\ListInstalled::class)->setArguments($argv); break;
          case 'install': $command = $main->getService(\HubletoMain\Cli\Agent\App\Install::class)->setArguments($argv); break;
          case 'disable': $command = $main->getService(\HubletoMain\Cli\Agent\App\Disable::class)->setArguments($argv); break;
          case 'reset-all': $command = $main->getService(\HubletoMain\Cli\Agent\App\ResetAll::class)->setArguments($argv); break;
          case 'create': $command = $main->getService(\HubletoMain\Cli\Agent\App\Create::class)->setArguments($argv); break;
        }
      break;
      case 'debug':
        switch ($argv[2]) {
          case 'test-oauth': $command = $main->getService(\HubletoMain\Cli\Agent\Debug\TestOauth::class)->setArguments($argv); break;
          case 'router': $command = $main->getService(\HubletoMain\Cli\Agent\Debug\Router::class)->setArguments($argv); break;
        }
      break;
      case 'create':
        switch ($argv[2]) {
          case 'app': $command = $main->getService(\HubletoMain\Cli\Agent\App\Create::class)->setArguments($argv); break;
          case 'model': $command = $main->getService(\HubletoMain\Cli\Agent\Create\Model::class)->setArguments($argv); break;
          case 'controller': $command = $main->getService(\HubletoMain\Cli\Agent\Create\Controller::class)->setArguments($argv); break;
          case 'view': $command = $main->getService(\HubletoMain\Cli\Agent\Create\View::class)->setArguments($argv); break;
          case 'mvc': $command = $main->getService(\HubletoMain\Cli\Agent\Create\TableFormViewAndController::class)->setArguments($argv); break;
          case 'api': $command = $main->getService(\HubletoMain\Cli\Agent\Create\ApiEndpoint::class)->setArguments($argv); break;
        }
      break;
      case 'project':
        switch ($argv[2]) {
          case 'init': $command = $main->getService(\HubletoMain\Cli\Agent\CommandInit::class)->setArguments($argv); break;
          case 'generate-demo-data': $command = $main->getService(\HubletoMain\Cli\Agent\Project\GenerateDemoData::class)->setArguments($argv); break;
        }
      break;
    }

    if ($command === null) {
      \Hubleto\Terminal::red("Don't know what to do.\n");
    } else {
      $command->run();
    }
  } catch (\Throwable $e) {
    \Hubleto\Terminal::red("{$e->getMessage()}\n");
    \Hubleto\Terminal::red($e->getTraceAsString()."\n");
  }
} else {
  \Hubleto\Terminal::green("Usage: php hubleto <command>\n");
  \Hubleto\Terminal::green("Example: php hubleto help\n");
}
